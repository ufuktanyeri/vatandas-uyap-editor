---
description: Proje bağlamı ve mevcut durum — yeni oturumda kaldığımız yeri hatırlamak için.
globs:
alwaysApply: true
---

# Proje Bağlamı — UYAP Evrak İndirici

## Mevcut Sürüm ve Durum

- **Sürüm:** v2.1.0 (manifest.json güncel)
- **Son commit:** `8a546ce` — fix(style): replace hardcoded error colors with CSS variable
- **Repo:** https://github.com/ufuktanyeri/vatandas-uyap-editor
- **Branch:** main

## Tamamlanan Önemli Çalışmalar

1. **State-UI decoupling** — AppState.onReset callback pattern ile UI bağımlılığı kaldırıldı
2. **Downloader decoupling** — AppState erişimi parametreye çevrildi, dinamik endpoint routing eklendi
3. **XSS koruma** — escapeHtml() constants.js'e taşındı, tüm stats HTML escape edildi (v2.1.0 #1 ✅)
4. **CSS değişkenleri** — Tüm hardcoded hex renkler CSS değişkenlerine taşındı (v2.1.0 #6, #7 ✅)
5. **Multi-dosya context tracking** — dosyaGecmisi Map, oturumStats, saveDosyaContext/restoreDosyaContext
6. **Birim test altyapısı** — Vitest + jsdom, 70 test (constants: 31, scanner: 17, state: 22) (v2.3.0 #5 ✅)
7. **Yargı türü desteği** — Tüm yargiTuru'ler için doğru endpoint routing
8. **UYAP DOM doğrulaması** — Chrome Claude ile canlı DOM analizi yapıldı, tüm selector'lar doğrulandı
9. **window.dosyaId keşfi** — UYAP global olarak tanımlıyor, findDosyaId() basitleştirilebilir

## Bekleyen Görevler (v2.2.0)

Detaylar: `docs/todo-by-prompt.md`

### Yeni Bulgular (kod kalitesi değerlendirmesinden)
- **BUG:** scanFiletree() filetree bulunamazsa `[]` dönüyor, `{ tree:[], flatList:[] }` dönmeli
- **Duplicate kod:** findDosyaId + getYargiTuru jQuery parsing → ortak helper
- **#8 güncelleme:** window.dosyaId global mevcut, innerHTML tamamen kaldırılabilir

### Mevcut Todo
1. **#3 Eski Flat Rendering Temizliği** — ui.js/main.js/state.js ~120 satır ölü kod
2. **#4 IIFE Global Scope Temizliği** — constants.js + scanner.js (~27 global)
3. **#2 Blob URL İndirme Geçişi** — base64 yerine blob URL (bellek %33 tasarruf)
4. **#8 Scanner findDosyaId** — window.dosyaId kontrolü ekle, innerHTML kaldır
5. **#10 SW Promise Wrapper** — callback→native Promise
6. **#11 DOCX vs UDF** — ZIP magic bytes sonrası Content_Types kontrolü
7. **#9 JSDoc** — Tüm dosyalara type annotation
8. **#12 CHANGELOG.md** — Keep a Changelog formatında başlat

## Test Çalıştırma

```
npm test          # Vitest run (tek sefer)
npm run test:watch # Vitest watch mode
npm run lint       # ESLint
```

## Kritik Hatırlatmalar

- Content script'ler global scope, modül sistemi yok — test setup `vm.runInThisContext` ile yüklüyor
- UYAP DOM'una dokunma — jQuery event'leri bağlı, DOM değişikliği UYAP'ı bozar
- Downloader IIFE internal fonksiyonları (detectFileType vb.) henüz test edilmiyor
- escapeHtml() çift tırnak escape etmez (textContent+innerHTML yaklaşımı, beklenen davranış)
- WAF koruması: indirmeler arası minimum 300ms gecikme zorunlu
- PowerShell'de HERE-DOC desteklenmiyor — commit mesajları .git/COMMIT_MSG dosyası ile yazılmalı

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UYAP Evrak İndirici — Kod Haritası</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;display:flex;flex-direction:column}

  header{padding:24px 32px 16px;border-bottom:1px solid #1e293b}
  header h1{font-size:22px;font-weight:700;color:#f8fafc;margin-bottom:4px}
  header p{font-size:13px;color:#94a3b8}

  .legend{display:flex;gap:20px;padding:12px 32px;border-bottom:1px solid #1e293b;flex-wrap:wrap}
  .legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:#94a3b8}
  .legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}

  #chart{flex:1;overflow:auto;padding:16px 0}

  .node text{font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;fill:#cbd5e1;font-size:13px;cursor:default}
  .node text.label-name{font-weight:500}
  .node text.label-meta{fill:#64748b;font-size:11px}
  .node text.label-lines{fill:#475569;font-size:10px;font-family:"SF Mono",Consolas,"Courier New",monospace}

  .node circle{cursor:pointer;stroke-width:2;transition:r .15s}
  .node circle:hover{r:7}

  .link{fill:none;stroke:#1e293b;stroke-width:1.5}

  .tooltip{position:fixed;padding:10px 14px;background:#1e293b;border:1px solid #334155;border-radius:8px;font-size:12px;color:#e2e8f0;pointer-events:none;opacity:0;transition:opacity .15s;z-index:100;max-width:340px;line-height:1.6;box-shadow:0 8px 24px rgba(0,0,0,.4)}
  .tooltip strong{color:#f8fafc}
  .tooltip .tag{display:inline-block;padding:1px 6px;border-radius:3px;font-size:10px;font-weight:600;margin-right:4px}
  .tooltip .tag-green{background:#065f46;color:#6ee7b7}
  .tooltip .tag-yellow{background:#713f12;color:#fde68a}
  .tooltip .tag-red{background:#7f1d1d;color:#fca5a5}
</style>
</head>
<body>

<header>
  <h1>UYAP Evrak İndirici v2.1.0 — Kod Haritası</h1>
  <p>Interaktif D3 indented tree · Düğümlere tıklayarak açıp kapatabilirsiniz · Son güncelleme: 27 Şubat 2026</p>
</header>

<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:#34d399"></div> Temiz modül</div>
  <div class="legend-item"><div class="legend-dot" style="background:#fbbf24"></div> Dikkat – orta karmaşıklık / risk</div>
  <div class="legend-item"><div class="legend-dot" style="background:#f87171"></div> Sorunlu coupling / yüksek karmaşıklık</div>
  <div class="legend-item"><div class="legend-dot" style="background:#818cf8"></div> Klasör / Grup</div>
  <div class="legend-item"><div class="legend-dot" style="background:#38bdf8"></div> Fonksiyon / Metot</div>
</div>

<div id="chart"></div>
<div class="tooltip" id="tooltip"></div>

<script>
const treeData = {
  name: "uyap-evrak-indirici",
  meta: "Chrome Extension · Manifest V3 · v2.1.0",
  health: "group",
  children: [
    {
      name: "manifest.json",
      meta: "32 satır · Giriş noktası",
      health: "green",
      tip: "Manifest V3 yapılandırması. permissions: activeTab, storage, downloads. Content scripts sıralı yüklenir. v2.1.0 güncel.",
      children: [
        { name: "permissions", meta: "activeTab, storage, downloads", health: "green", tip: "Minimum yetki prensibi uygulanmış." },
        { name: "content_scripts", meta: "6 JS + 1 CSS, document_idle", health: "green", tip: "Yükleme sırası: constants → scanner → downloader → state → ui → main" },
        { name: "background.service_worker", meta: "module type", health: "green", tip: "ES module olarak tanımlanmış." }
      ]
    },
    {
      name: "content/",
      meta: "6 dosya · ~2,167 satır",
      health: "group",
      children: [
        {
          name: "constants.js",
          meta: "156 satır · Düşük karmaşıklık",
          health: "green",
          tip: "Sabitler, konfigürasyon ve utility fonksiyonlar. Coupling yok. Global scope'a ~18 değişken yayar (IIFE sarma bekliyor). escapeHtml() burada tanımlı.",
          children: [
            { name: "UYAP_BASE_URL", meta: "const string", health: "green", tip: "UYAP base URL sabiti" },
            { name: "DOWNLOAD_ENDPOINTS", meta: "const object", health: "green", tip: "yargiTuru → endpoint mapping: DEFAULT, DANISTAY (İcra), YARGITAY, KVK. Application.getDownloadURL aynalaması." },
            { name: "getDownloadEndpoint()", meta: "function · pure", health: "green", tip: "yargiTuru parametresine göre doğru download endpoint döner." },
            { name: "MAGIC_BYTES", meta: "const object", health: "green", tip: "PDF, ZIP, TIFF_LE, TIFF_BE, PNG, JPEG magic byte dizileri." },
            { name: "MIME_TYPES", meta: "const object", health: "green", tip: "PDF, UDF, TIFF, PNG, JPEG, HTML, UNKNOWN MIME tipleri. ZIP her zaman UDF olarak etiketleniyor (DOCX ayrımı bekliyor)." },
            { name: "FILE_EXTENSIONS", meta: "const object", health: "green", tip: ".pdf, .udf, .tiff, .png, .jpg, .html uzantıları" },
            { name: "SELECTORS", meta: "const object", health: "green", tip: "UYAP DOM seçicileri. Canlı DOM analiziyle doğrulandı (27 Şubat 2026)." },
            { name: "SKIP_FOLDERS", meta: "const array", health: "green", tip: "'Son 20 Evrak', 'Son20'. UYAP'ta 'Dosyaya Eklenen Son 20 Evrak' olarak geçiyor — includes() ile eşleşir." },
            { name: "DEFAULT_SETTINGS", meta: "const object", health: "green", tip: "downloadDelay: 300ms, autoRetry: true, keepFolderStructure: true" },
            { name: "YARGI_TURLERI", meta: "const object", health: "green", tip: "10 tür: 0-Ceza, 1-Hukuk, 2-İcra, 3-Yargıtay, 5-Adli Tıp, 6-İdari Yargı, 11-Satış Memurluğu, 25-Arabuluculuk, 26-Tazminat Komisyonu, kvk-KVK." },
            { name: "RETRY_CONFIG", meta: "const object", health: "green", tip: "MAX_RETRIES: 2, BASE_DELAY: 1s, DELAY_MULTIPLIER: 2" },
            { name: "TIMEOUTS", meta: "const object", health: "green", tip: "FILETREE_LOAD: 30s, MUTATION_DEBOUNCE: 150ms, POLLING: 500ms, BLOB_CLEANUP: 100ms, PAUSE_CHECK: 100ms" },
            { name: "UI_MESSAGES", meta: "const object", health: "green", tip: "Türkçe UI mesajları ve ikonlar" },
            { name: "STORAGE_KEYS", meta: "const object", health: "green", tip: "chrome.storage anahtarları" },
            { name: "sanitizeName()", meta: "function · pure", health: "green", tip: "Dosya adı temizleme: kontrol karakterleri, Windows geçersiz karakterler, uzunluk limiti 200" },
            { name: "escapeHtml()", meta: "function · security", health: "green", tip: "HTML özel karakterlerini escape et (XSS önleme). createElement + textContent → innerHTML. Çift tırnak escape etmez (beklenen davranış)." }
          ]
        },
        {
          name: "scanner.js",
          meta: "342 satır · Orta karmaşıklık",
          health: "yellow",
          tip: "DOM tarama ve evrak çıkarma. Tüm selector'lar canlı DOM ile doğrulandı. BUG: scanFiletree() hata dönüşü [] — {tree:[],flatList:[]} olmalı. findDosyaId() hâlâ innerHTML kullanıyor (window.dosyaId mevcut, geçiş bekliyor). Duplicate jQuery parsing kodu var.",
          children: [
            { name: "findDosyaId()", meta: "function · DOM erişim", health: "red", tip: "BUG: document.body.innerHTML regex (ağır). UYAP window.dosyaId global tanımlıyor — buna geçilmeli. Duplicate jQuery._data kodu getYargiTuru() ile paylaşılıyor." },
            { name: "getYargiTuru()", meta: "function · 3 fallback", health: "green", tip: "1) #yargiTuru select element, 2) jQuery handler parse, 3) varsayılan '1'. UYAP DOM ile doğrulandı: select her zaman mevcut, 8 option." },
            { name: "findKisiAdi()", meta: "function · DOM erişim", health: "green", tip: "Header'dan kullanıcı adı. UYAP DOM ile doğrulandı: .username.username-hide-on-mobile + #ad çalışıyor." },
            { name: "getDosyaBilgileri()", meta: "function · orchestrator", health: "green", tip: "dosyaId + dosyaNo + yargiTuru birleştirici. textContent kullanımı güvenli." },
            { name: "parseTooltip()", meta: "function · pure", health: "green", tip: "<div>Key: Value</div> format. UYAP DOM ile doğrulandı: data-original-title dolu, title boş." },
            { name: "scanFiletree()", meta: "function · recursive", health: "yellow", tip: "BUG: Filetree bulunamazsa return [] — main.js crash eder. return {tree:[],flatList:[]} olmalı." },
            { name: "buildTreeFromFlat()", meta: "function · transformer", health: "green", tip: "Flat→nested tree. evrakId key ile aynı isim çakışmasını önler." },
            { name: "detectPagination()", meta: "function · DOM regex", health: "green", tip: "UYAP DOM ile doğrulandı: 'Toplam X sayfadan Y. sayfa gösteriliyor.' Navigasyon butonları: ul.pagination.bootpag." },
            { name: "waitForFiletree()", meta: "function · async polling", health: "green", tip: "Promise tabanlı DOM polling. Timeout kontrolü ile." }
          ]
        },
        {
          name: "downloader.js",
          meta: "341 satır · Orta karmaşıklık",
          health: "yellow",
          tip: "İndirme motoru IIFE. AppState coupling yok, parametrik API. Kalan sorunlar: base64 data URL bellek overhead'ı (%33), IIFE iç fonksiyonlar test edilemiyor, ZIP her zaman UDF.",
          children: [
            { name: "detectFileType()", meta: "private · pure", health: "yellow", tip: "Magic bytes ile dosya tipi tespiti. ZIP her zaman UDF — DOCX ayrımı yok." },
            { name: "isHtmlResponse()", meta: "private · pure", health: "green", tip: "İlk 500 byte'ı TextDecoder ile kontrol. Session expired tespiti." },
            { name: "arrayBufferToBase64()", meta: "private · pure", health: "yellow", tip: "Chunked base64 (8KB). 10MB PDF → 13MB string. Blob URL'ye geçilmeli." },
            { name: "sleep()", meta: "private · utility", health: "green", tip: "Promise tabanlı setTimeout wrapper." },
            { name: "downloadSingle()", meta: "private · async", health: "green", tip: "Dinamik endpoint routing. fetch + magic bytes + Chrome Downloads API + blob fallback." },
            { name: "downloadWithRetry()", meta: "private · async", health: "green", tip: "Exponential backoff retry. Session expired ve iptal durumlarında retry yapmaz." },
            { name: "downloadSimple()", meta: "private · sync", health: "green", tip: "window.downloadDoc() wrapper. Basit mod fallback." },
            { name: "downloadAll()", meta: "public · async", health: "green", tip: "Parametreler: (evraklar, dosya, settings, onProgress, onSessionExpired, useSimpleMode). Dönüş: {completed, failed, total, sessionExpired}." },
            { name: "pause()", meta: "public", health: "green", tip: "isPaused = true" },
            { name: "resume()", meta: "public", health: "green", tip: "isPaused = false" },
            { name: "cancel()", meta: "public", health: "green", tip: "AbortController.abort()" },
            { name: "isPausedState()", meta: "public · getter", health: "green", tip: "return isPaused" },
            { name: "isCancelled()", meta: "public · getter", health: "green", tip: "return abortController.signal.aborted" },
            { name: "getCurrentIndex()", meta: "public · getter", health: "green", tip: "return currentIndex" }
          ]
        },
        {
          name: "state.js",
          meta: "348 satır · Orta karmaşıklık",
          health: "green",
          tip: "Uygulama durumu plain object. UI coupling yok (onReset callback). Multi-dosya context tracking: dosyaGecmisi Map ile oturum boyunca indirme geçmişi. Kalan: 3 metot ölü kod (flat rendering fallback).",
          children: [
            { name: "onReset", meta: "property · callback", health: "green", tip: "Reset callback. main.js tarafından atanır." },
            { name: "evraklar[]", meta: "property · array", health: "green", tip: "Taranan evrak listesi" },
            { name: "seciliEvrakIds", meta: "property · Set", health: "green", tip: "Seçili evrak ID'leri. O(1) lookup." },
            { name: "treeData", meta: "property · nested", health: "green", tip: "Ağaç yapısı verisi" },
            { name: "expandedFolders", meta: "property · Set", health: "green", tip: "Açık klasör path'leri" },
            { name: "downloadedEvrakIds", meta: "property · Set", health: "green", tip: "Aktif dosyada indirilen evrak ID'leri" },
            { name: "dosyaGecmisi", meta: "property · Map", health: "green", tip: "Multi-dosya: dosyaId → {dosyaBilgileri, downloadedEvrakIds, stats, evrakSayisi, yargiTuruAdi}" },
            { name: "oturumStats", meta: "property · object", health: "green", tip: "Oturum geneli: toplamIndirilen, toplamBasarisiz" },
            { name: "getGroupedEvraklar()", meta: "method · dead code", health: "yellow", tip: "Ölü kod: sadece eski flat rendering fallback tarafından kullanılıyor. T-1'de kaldırılacak." },
            { name: "toggleEvrakSecimi()", meta: "method · mutator", health: "green", tip: "Set add/delete toggle." },
            { name: "tumunuSec()", meta: "method · mutator", health: "green", tip: "Tüm evrak ID'lerini Set'e ekle." },
            { name: "secimiTemizle()", meta: "method · mutator", health: "green", tip: "Set'i sıfırla." },
            { name: "klasorEvraklariniSec()", meta: "method · dead code", health: "yellow", tip: "Ölü kod: sadece eski fallback. T-1'de kaldırılacak." },
            { name: "klasorEvraklariniKaldir()", meta: "method · dead code", health: "yellow", tip: "Ölü kod: sadece eski fallback. T-1'de kaldırılacak." },
            { name: "getSeciliEvraklar()", meta: "method · getter", health: "green", tip: "Seçili evrakları filtrele ve döndür." },
            { name: "toggleFolderExpanded()", meta: "method · mutator", health: "green", tip: "Klasör açık/kapalı state toggle." },
            { name: "findNodeByPath()", meta: "method · recursive", health: "green", tip: "Tree'de fullPath ile node arama." },
            { name: "selectAllInFolder()", meta: "method · recursive", health: "green", tip: "Klasördeki tüm dosyaları seç." },
            { name: "deselectAllInFolder()", meta: "method · recursive", health: "green", tip: "Klasördeki tüm seçimi kaldır." },
            { name: "isFolderFullySelected()", meta: "method · recursive", health: "green", tip: "Tüm dosyalar seçili mi? every() kontrolü." },
            { name: "getFileCountInFolder()", meta: "method · recursive", health: "green", tip: "Klasördeki toplam dosya sayısı." },
            { name: "saveDosyaContext()", meta: "method · multi-dosya", health: "green", tip: "Mevcut dosyanın indirme geçmişini dosyaGecmisi Map'ine kaydet. Tekrar kaydetmelerde istatistikler biriktirilir." },
            { name: "restoreDosyaContext()", meta: "method · multi-dosya", health: "green", tip: "Daha önce taranan dosyanın downloadedEvrakIds'ini geri yükle." },
            { name: "getDosyaGecmisi()", meta: "method · getter", health: "green", tip: "Belirli dosya için geçmiş döndür." },
            { name: "isEvrakDownloaded()", meta: "method · lookup", health: "green", tip: "Evrak herhangi bir dosyada indirilmiş mi? Tüm geçmişi kontrol eder." },
            { name: "_recalcOturumStats()", meta: "method · private", health: "green", tip: "dosyaGecmisi'nden oturum istatistiklerini yeniden hesapla." },
            { name: "getOturumOzeti()", meta: "method · getter", health: "green", tip: "Oturum genelinde işlenen dosya listesi ve istatistikler." },
            { name: "resetActiveDosya()", meta: "method · partial reset", health: "green", tip: "Aktif dosya state'ini temizle, dosya geçmişi ve oturum stats korunur." },
            { name: "reset()", meta: "method · full reset", health: "green", tip: "Tam sıfırlama: resetActiveDosya() + dosyaGecmisi + oturumStats + kisiAdi." }
          ]
        },
        {
          name: "ui.js",
          meta: "457 satır · Orta karmaşıklık",
          health: "yellow",
          tip: "UI bileşenleri IIFE. innerHTML + string concatenation. escapeHtml() her yerde kullanılıyor. Kalan: ~80 satır ölü flat rendering kodu (T-1'de temizlenecek).",
          children: [
            { name: "$()", meta: "private · helper", health: "green", tip: "querySelector wrapper." },
            { name: "$$()", meta: "private · helper", health: "green", tip: "querySelectorAll → Array wrapper." },
            { name: "createUI()", meta: "public · DOM", health: "green", tip: "innerHTML ile ana UI yapısı. FAB + drawer + panel layout." },
            { name: "openDrawer()", meta: "public · DOM", health: "green", tip: "CSS class toggle ile drawer açma." },
            { name: "closeDrawer()", meta: "public · DOM", health: "green", tip: "CSS class toggle ile drawer kapatma." },
            { name: "updateStats()", meta: "public · DOM", health: "green", tip: "innerHTML ile stats güncelleme. Çağıran taraf escape etmeli — tüm çağrı noktaları kontrol edildi, güvenli." },
            { name: "renderTreeView()", meta: "private · recursive", health: "green", tip: "Recursive tree HTML renderer. escapeHtml() kullanılmış. AppState'e doğrudan erişir (coupling)." },
            { name: "renderEvraklar()", meta: "public · DOM", health: "yellow", tip: "Tree data varsa renderTreeView(), yoksa eski fallback. Dual code path — T-1'de fallback kaldırılacak." },
            { name: "renderEvrakCard()", meta: "private · dead code", health: "yellow", tip: "Ölü kod: eski flat rendering kartı. T-1'de kaldırılacak." },
            { name: "updateSelectionUI()", meta: "public · DOM", health: "green", tip: "Sayaç ve buton durumu güncelleme." },
            { name: "updateProgress()", meta: "public · DOM", health: "green", tip: "Progress bar güncelleme. CSS class ile durum renklendirme." },
            { name: "showProgressError()", meta: "public · DOM", health: "green", tip: "textContent ile hata mesajı. XSS güvenli." },
            { name: "showSessionAlert()", meta: "public · DOM", health: "green", tip: "Session expired alert gösterme." },
            { name: "showMode()", meta: "public · state machine", health: "green", tip: "5 mod: scan, scanning, select, downloading, completed." }
          ]
        },
        {
          name: "main.js",
          meta: "523 satır · Yüksek karmaşıklık",
          health: "yellow",
          tip: "Orkestratör IIFE. Event delegation, cleanup altyapısı, multi-dosya context. Tüm stats HTML escape edilmiş (XSS güvenli). Tüm renkler CSS değişkeni. Kalan: ~40 satır ölü fallback event handler (T-1'de temizlenecek).",
          children: [
            { name: "eventRegistry", meta: "Map · cleanup", health: "green", tip: "Element → [{event, handler}] eşlemesi. Cleanup için tüm listener'ları track eder." },
            { name: "registerEventListener()", meta: "private · infra", health: "green", tip: "addEventListener + registry'ye kayıt." },
            { name: "cleanupObservers()", meta: "private · cleanup", health: "green", tip: "MutationObserver.disconnect()" },
            { name: "cleanupEventListeners()", meta: "private · cleanup", health: "green", tip: "Tüm kayıtlı listener'ları removeEventListener ile temizle." },
            { name: "init()", meta: "private · lifecycle", health: "green", tip: "createUI → bindEvents → observeModal → onReset callback bağlama → beforeunload cleanup." },
            { name: "bindEvents()", meta: "private · ~170 satır", health: "yellow", tip: "Tüm event binding'leri tek fonksiyonda. Fat function. ~40 satır ölü eski grup handler (T-1'de temizlenecek)." },
            { name: "buildOturumStatsHtml()", meta: "private · template", health: "green", tip: "Multi-dosya oturum geçmişi HTML'i. escapeHtml() ile XSS güvenli." },
            { name: "handleScan()", meta: "private · async", health: "green", tip: "Tarama akışı: waitForFiletree → scanFiletree → multi-dosya context restore → render. Tüm dinamik değerler escaped." },
            { name: "handleDownload()", meta: "private · async", health: "green", tip: "Downloader.downloadAll() parametrik çağrı. downloadedEvrakIds takibi. Oturum özeti." },
            { name: "handlePause()", meta: "private · toggle", health: "green", tip: "Pause/Resume toggle. Buton text ve class güncelleme." },
            { name: "handleCancel()", meta: "private", health: "green", tip: "Downloader.cancel() + UI mode reset." },
            { name: "isModalVisible()", meta: "private · DOM check", health: "green", tip: "UYAP DOM ile doğrulandı: 'in' class + display/visibility kontrolü." },
            { name: "observeModal()", meta: "private · MutationObserver", health: "green", tip: "Modal kapanınca saveDosyaContext() → resetActiveDosya(). Debounce 150ms." }
          ]
        }
      ]
    },
    {
      name: "background/",
      meta: "1 dosya · 90 satır",
      health: "group",
      children: [
        {
          name: "service-worker.js",
          meta: "90 satır · Düşük karmaşıklık",
          health: "green",
          tip: "Background service worker. Temiz, minimalist. Message routing + Chrome APIs. Kalan: gereksiz callback-based Promise wrapper (T-5'te düzeltilecek).",
          children: [
            { name: "handleMessage()", meta: "async · router", health: "green", tip: "switch/case message router: GET_SETTINGS, SET_SETTINGS, DOWNLOAD_FILE." },
            { name: "getSettings()", meta: "async · storage", health: "yellow", tip: "Gereksiz Promise wrapper — MV3'te chrome.storage.local.get() native Promise döndürüyor. T-5'te düzeltilecek." },
            { name: "setSettings()", meta: "async · storage", health: "yellow", tip: "Gereksiz Promise wrapper — MV3'te chrome.storage.local.set() native Promise döndürüyor. T-5'te düzeltilecek." },
            { name: "downloadFile()", meta: "async · downloads", health: "green", tip: "chrome.downloads.download wrapper. saveAs: false, conflictAction: 'uniquify'." },
            { name: "onInstalled", meta: "event · lifecycle", health: "green", tip: "install/update loglama." }
          ]
        }
      ]
    },
    {
      name: "styles/",
      meta: "1 dosya · 658 satır",
      health: "group",
      children: [
        {
          name: "panel.css",
          meta: "658 satır",
          health: "green",
          tip: "İyi organize edilmiş CSS. .uyap-ext- prefix ile namespace. Tüm renkler CSS değişkenlerine taşındı (v2.1.0). Kalan: ~50 satır ölü .uyap-ext-group__* stilleri (T-1'de temizlenecek).",
          children: [
            { name: ":root değişkenleri", meta: "33 satır · Tema", health: "green", tip: "--uyap-color-*, --uyap-z-* değişkenleri. Tutarlı renk sistemi." },
            { name: "Scoped Reset", meta: ".uyap-ext-panel *", health: "green", tip: "box-sizing: border-box. UYAP DOM'unu etkilemez." },
            { name: "FAB Bileşeni", meta: "~50 satır", health: "green", tip: "Animasyonlar: enter + pulse. Responsive (3 breakpoint)." },
            { name: "Drawer + Overlay", meta: "~40 satır", health: "green", tip: "CSS transition ile açılma/kapanma. Responsive width. font-family tanımlı." },
            { name: "Scrollbar", meta: "~10 satır", health: "green", tip: "CSS değişkenleri: text-tertiary, text-secondary." },
            { name: "Panel Layout", meta: "~80 satır", health: "green", tip: "Flexbox layout: header, stats, actions, body. Tüm renkler CSS değişkeni." },
            { name: "Buttons", meta: "~40 satır", health: "green", tip: "CSS değişkenleri ile renklendirme. !important (UYAP override gerekli)." },
            { name: "Evrak Group", meta: "~50 satır · dead code", health: "yellow", tip: "Ölü kod: eski flat grup stilleri. Tree view aktif — T-1'de kaldırılacak." },
            { name: "Evrak Card", meta: "~30 satır · kısmen dead", health: "yellow", tip: ".uyap-ext-card__checkbox ve .uyap-ext-card__meta tree view'de kullanılıyor. .uyap-ext-card, __content, __name ölü." },
            { name: "Tree View", meta: "~130 satır", health: "green", tip: "Tüm renkler CSS değişkeni. Folder/file node, toggle, icon, metadata styling." },
            { name: "Progress Bar", meta: "~60 satır", health: "green", tip: "Stripe animasyonu. 4 durum rengi CSS değişkeni ile." },
            { name: "Session Alert", meta: "~30 satır", health: "green", tip: "CSS değişkenleri ile renklendirme." },
            { name: "Mode Toggle", meta: "~20 satır", health: "green", tip: "Basit/Gelişmiş mod toggle." },
            { name: "Session Summary", meta: "~20 satır", health: "green", tip: "Multi-dosya oturum özeti stilleri. Dashed border-top ile ayrım." }
          ]
        }
      ]
    },
    {
      name: "tests/",
      meta: "3 dosya + setup · 70 test",
      health: "group",
      children: [
        { name: "setup.js", meta: "ESM · vm.runInThisContext", health: "green", tip: "Content script'leri global scope'a yükler: constants.js → scanner.js → state.js → downloader.js. jsdom ortamı." },
        { name: "constants.test.js", meta: "31 test", health: "green", tip: "sanitizeName(), escapeHtml(), getDownloadEndpoint(), MAGIC_BYTES, YARGI_TURLERI testleri." },
        { name: "scanner.test.js", meta: "17 test", health: "green", tip: "parseTooltip(), buildTreeFromFlat(), detectPagination() testleri." },
        { name: "state.test.js", meta: "22 test", health: "green", tip: "Seçim, klasör, multi-dosya context (save/restore/isDownloaded/recalc/ozet), reset testleri." }
      ]
    },
    {
      name: "config/",
      meta: "Geliştirme araçları",
      health: "group",
      children: [
        { name: "eslint.config.js", meta: "216 satır · ESM", health: "green", tip: "Per-file globals yapılandırması. Content scripts + background + tests. Bağımlılık zinciri doğru tanımlı." },
        { name: "vitest.config.js", meta: "ESM · jsdom", health: "green", tip: "Test ortamı: jsdom, setup: tests/setup.js, globals: true." },
        { name: ".prettierrc", meta: "JSON · code style", health: "green", tip: "singleQuote: true, printWidth: 100, trailingComma: es5" },
        { name: "package.json", meta: "scripts + devDeps", health: "green", tip: "Scripts: test, test:watch, lint. DevDeps: eslint, prettier, vitest, jsdom." }
      ]
    }
  ]
};

const healthColors = {
  green:  "#34d399",
  yellow: "#fbbf24",
  red:    "#f87171",
  group:  "#818cf8"
};

const healthLabels = {
  green:  "Temiz",
  yellow: "Dikkat",
  red:    "Sorunlu",
  group:  "Grup"
};

const margin = { top: 10, right: 30, bottom: 10, left: 30 };
const nodeHeight = 28;
const indentSize = 22;

const root = d3.hierarchy(treeData);
root.descendants().forEach((d, i) => { d.id = i; d._children = d.children; });

const svg = d3.select("#chart").append("svg")
  .attr("width", "100%")
  .style("font", "13px system-ui, sans-serif");

const gLink = svg.append("g")
  .attr("fill", "none")
  .attr("stroke", "#1e293b")
  .attr("stroke-width", 1.5);

const gNode = svg.append("g");

const tooltip = document.getElementById("tooltip");

function update(source) {
  const duration = 280;
  const nodes = root.descendants().reverse();
  const links = root.links();

  let index = -1;
  root.eachBefore(d => {
    d.x = ++index * nodeHeight;
    d.y = d.depth * indentSize;
  });

  const height = (index + 1) * nodeHeight + margin.top + margin.bottom;
  const maxDepth = d3.max(nodes, d => d.depth);
  const width = Math.max(900, maxDepth * indentSize + 700);

  svg.transition().duration(duration)
    .attr("height", height)
    .attr("viewBox", [-margin.left, -margin.top, width, height]);

  const node = gNode.selectAll("g.node")
    .data(nodes, d => d.id);

  const nodeEnter = node.enter().append("g")
    .attr("class", "node")
    .attr("transform", `translate(${source.y0 || 0},${source.x0 || 0})`)
    .attr("opacity", 0);

  nodeEnter.append("circle")
    .attr("r", 5)
    .attr("fill", d => d._children ? healthColors[d.data.health] || "#818cf8" : "transparent")
    .attr("stroke", d => healthColors[d.data.health] || "#38bdf8")
    .on("click", (event, d) => {
      d.children = d.children ? null : d._children;
      update(d);
    });

  nodeEnter.append("text")
    .attr("class", "label-name")
    .attr("dy", "0.32em")
    .attr("x", 12)
    .text(d => d.data.name)
    .attr("fill", d => {
      if (d.data.health === "red") return "#fca5a5";
      if (d.data.health === "yellow") return "#fde68a";
      if (d.data.health === "group") return "#a5b4fc";
      return "#e2e8f0";
    });

  nodeEnter.append("text")
    .attr("class", "label-meta")
    .attr("dy", "0.32em")
    .attr("x", d => 16 + estimateTextWidth(d.data.name))
    .text(d => d.data.meta ? `  ${d.data.meta}` : "");

  nodeEnter
    .on("mouseenter", (event, d) => {
      if (!d.data.tip) return;
      const tag = d.data.health;
      const tagLabel = healthLabels[tag] || "";
      const tagClass = tag === "green" ? "tag-green" : tag === "yellow" ? "tag-yellow" : tag === "red" ? "tag-red" : "tag-green";
      tooltip.innerHTML = `<span class="tag ${tagClass}">${tagLabel}</span> <strong>${d.data.name}</strong><br>${d.data.tip}`;
      tooltip.style.opacity = "1";
    })
    .on("mousemove", (event) => {
      const pad = 16;
      let x = event.clientX + pad;
      let y = event.clientY + pad;
      const rect = tooltip.getBoundingClientRect();
      if (x + rect.width > window.innerWidth) x = event.clientX - rect.width - pad;
      if (y + rect.height > window.innerHeight) y = event.clientY - rect.height - pad;
      tooltip.style.left = x + "px";
      tooltip.style.top = y + "px";
    })
    .on("mouseleave", () => { tooltip.style.opacity = "0"; });

  const nodeUpdate = node.merge(nodeEnter).transition().duration(duration)
    .attr("transform", d => `translate(${d.y},${d.x})`)
    .attr("opacity", 1);

  nodeUpdate.select("circle")
    .attr("fill", d => d._children ? healthColors[d.data.health] || "#818cf8" : "transparent")
    .attr("stroke", d => healthColors[d.data.health] || "#38bdf8");

  const nodeExit = node.exit().transition().duration(duration)
    .attr("transform", `translate(${source.y},${source.x})`)
    .attr("opacity", 0)
    .remove();

  const link = gLink.selectAll("path.link")
    .data(links, d => d.target.id);

  const linkEnter = link.enter().append("path")
    .attr("class", "link")
    .attr("d", () => {
      const o = { x: source.x0 || 0, y: source.y0 || 0 };
      return linkPath({ source: o, target: o });
    });

  link.merge(linkEnter).transition().duration(duration)
    .attr("d", d => linkPath(d));

  link.exit().transition().duration(duration)
    .attr("d", () => {
      const o = { x: source.x, y: source.y };
      return linkPath({ source: o, target: o });
    })
    .remove();

  nodes.forEach(d => { d.x0 = d.x; d.y0 = d.y; });
}

function linkPath(d) {
  return `M${d.target.y},${d.target.x}
          C${d.source.y + indentSize / 2},${d.target.x}
           ${d.source.y + indentSize / 2},${d.source.x}
           ${d.source.y},${d.source.x}`;
}

function estimateTextWidth(text) {
  return text.length * 7.5;
}

update(root);
</script>
</body>
</html>
